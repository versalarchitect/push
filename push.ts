#!/usr/bin/env bun
import { $ } from "bun";
import { setTimeout } from "node:timers/promises";

const frames = [
  `
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚  â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ â”‚â–’
       â”‚  â–‘    PUSH    â–‘â–‘â–‘ â”‚â–’
       â”‚  â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ â”‚â–’
       â”‚                   â”‚â–’
       â”‚  â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’   â”‚â–’
       â”‚  â–’ PUSHING! â–’    â”‚â–’
       â”‚  â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’   â”‚â–’
       â”‚                   â”‚â–’
       â”‚   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â”‚â–’
       â”‚   â–ˆ TO GIT â–ˆ     â”‚â–’
       â”‚   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â”‚â–’
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â–’
        â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’
         â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’
  `,
  `
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â”‚â–‘
       â”‚  â–ˆ    PUSH    â–ˆ  â”‚â–‘
       â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â”‚â–‘
       â”‚                   â”‚â–‘
       â”‚  â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘   â”‚â–‘
       â”‚  â–‘ PUSHING! â–‘    â”‚â–‘
       â”‚  â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘   â”‚â–‘
       â”‚                   â”‚â–‘
       â”‚   â–’â–’â–’â–’â–’â–’â–’â–’â–’     â”‚â–‘
       â”‚   â–’ TO GIT â–’     â”‚â–‘
       â”‚   â–’â–’â–’â–’â–’â–’â–’â–’â–’     â”‚â–‘
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â–‘
        â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘
         â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘
  `,
  `
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚  â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’ â”‚â–ˆ
       â”‚  â–’    PUSH    â–’  â”‚â–ˆ
       â”‚  â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’ â”‚â–ˆ
       â”‚                   â”‚â–ˆ
       â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â”‚â–ˆ
       â”‚  â–ˆ  PUSHING! â–ˆ   â”‚â–ˆ
       â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â”‚â–ˆ
       â”‚                   â”‚â–ˆ
       â”‚   â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘    â”‚â–ˆ
       â”‚   â–‘ TO GIT  â–‘    â”‚â–ˆ
       â”‚   â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘    â”‚â–ˆ
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â–ˆ
        â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
         â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
  `,
  `
         â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’
        â–’â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–’
       â–’â”‚   â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘   â”‚â–’
       â–’â”‚   â–‘  PUSH  â–‘   â”‚â–’
       â–’â”‚   â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘   â”‚â–’
       â–’â”‚                â”‚â–’
       â–’â”‚   â–’â–’â–’â–’â–’â–’â–’â–’â–’   â”‚â–’
       â–’â”‚   â–’PUSHING!â–’   â”‚â–’
       â–’â”‚   â–’â–’â–’â–’â–’â–’â–’â–’â–’   â”‚â–’
       â–’â”‚                â”‚â–’
       â–’â”‚   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â”‚â–’
       â–’â”‚   â–ˆTO GITâ–ˆ    â”‚â–’
       â–’â”‚   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â”‚â–’
        â–’â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â–’
         â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’
  `,
  `
         â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
        â–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–ˆ
       â–ˆâ”‚    â–’â–’â–’â–’â–’â–’â–’    â”‚â–ˆ
       â–ˆâ”‚    â–’ PUSH â–’    â”‚â–ˆ
       â–ˆâ”‚    â–’â–’â–’â–’â–’â–’â–’    â”‚â–ˆ
       â–ˆâ”‚                â”‚â–ˆ
       â–ˆâ”‚    â–‘â–‘â–‘â–‘â–‘â–‘â–‘    â”‚â–ˆ
       â–ˆâ”‚   â–‘PUSHINGâ–‘    â”‚â–ˆ
       â–ˆâ”‚    â–‘â–‘â–‘â–‘â–‘â–‘â–‘    â”‚â–ˆ
       â–ˆâ”‚                â”‚â–ˆ
       â–ˆâ”‚    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â”‚â–ˆ
       â–ˆâ”‚    â–ˆTO GIT    â”‚â–ˆ
       â–ˆâ”‚    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â”‚â–ˆ
        â–ˆâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â–ˆ
         â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
  `
];

const successFrame = `
                      â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿
                      â£¿â£¿â£¿â£¿â£¿â£¿â£¿â ¿â ¿â ¿â ¿â ¿â ¿â ¿â ¿â ¿â ¿â ¿â ¿â ¿â ¿â¢¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿
                      â£¿â£¿â£¿â£¿â Ÿâ¢‰â£ â£¤â£¤â£¤â£¤â£¤â£¤â£¤â£¤â£¤â£¤â£¤â£¤â£¤â£¤â£„â¡ˆâ »â£¿â£¿â£¿â£¿â£¿â£¿
                      â£¿â£¿â¡¿â â£°â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£†â ˆâ¢¿â£¿â£¿â£¿â£¿
                      â£¿â£¿â â£´â£¿â£¿â£¿â£¿â£¿â¡¿â ‹â£‰â ‰â ™â¢¿â£¿â¡¿â ‹â£‰â ‰â ™â¢¿â£¿â£¿â£§â ˆâ£¿â£¿â£¿â£¿
                      â£¿â¡Ÿâ¢ â£¿â£¿â£¿â£¿â¡¿â ‹â£ â£¾â£¿â£·â£„â ˆâ¢¿â ƒâ£°â£¿â£¿â£¦â ˆâ¢¿â£¿â£¿â¡„â¢¹â£¿â£¿â£¿
                      â£¿â¡‡â¢¸â£¿â£¿â£¿â£¿â â£¾â£¿â£¿â£¿â£¿â£¿â£‡â ˜â¢°â£¿â£¿â£¿â£¿â£§â ˜â£¿â£¿â¡‡â¢¸â£¿â£¿â£¿
                      â£¿â¡‡â¢¸â£¿â£¿â£¿â£¿â ˜â£¿â£¿â£¿â£¿â£¿â£¿â¡¿â¢€â£¿â£¿â£¿â£¿â£¿â¡¿â¢€â£¿â£¿â¡‡â¢¸â£¿â£¿â£¿
                      â£¿â¡‡â¢¸â£¿â£¿â£¿â£¿â£§â ˆâ¢¿â£¿â£¿â£¿â¡Ÿâ¢ â£¾â£¿â£¿â£¿â£¿â Ÿâ¢ â£¾â£¿â£¿â¡‡â¢¸â£¿â£¿â£¿
                      â£¿â£§â ˆâ£¿â£¿â£¿â£¿â£¿â£¦â ˆâ »â Ÿâ¢‹â£´â£¿â£¿â£¿â£¿â Ÿâ¢‹â£´â£¿â£¿â£¿â£¿â €â£¼â£¿â£¿â£¿
                      â£¿â£¿â¡„â ˜â¢¿â£¿â£¿â£¿â£¿â£·â£¤â£´â£¿â£¿â£¿â£¿â£¿â£¥â£´â£¿â£¿â£¿â£¿â¡¿â ƒâ¢ â£¿â£¿â£¿â£¿
                      â£¿â£¿â£¿â£„â ˆâ ›â¢¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â¡¿â ‹â¢€â£´â£¿â£¿â£¿â£¿â£¿
                      â£¿â£¿â£¿â£¿â£·â£¤â£€â ‰â ›â ¿â¢¿â£¿â£¿â£¿â£¿â¡¿â ¿â ›â¢‹â£â£¤â£´â£¾â£¿â£¿â£¿â£¿â£¿â£¿â£¿
                      â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¶â£¶â£¤â£¤â£¤â£¤â£¤â£¤â£¶â£¾â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿
                                                          
                    âœ¨ Successfully pushed changes! âœ¨
                       ğŸš€ Your code is in orbit! ğŸš€
                    ğŸ’« Commit message added with style ğŸ’«
`;

async function animate() {
  let i = 0;
  const totalSpins = 4; // Number of complete spins
  const totalFrames = frames.length * totalSpins;
  const speeds = [120, 100, 80, 60]; // Variable speeds for dynamic effect
  
  while (i < totalFrames) {
    console.clear();
    console.log(frames[i % frames.length]);
    // Speed up the animation gradually
    const speedIndex = Math.min(Math.floor(i / frames.length), speeds.length - 1);
    await setTimeout(speeds[speedIndex]);
    i++;
  }
  console.clear();
  console.log(successFrame);
}

async function generateCommitMessage(diff: string): Promise<string> {
  try {
    const response = await fetch('http://localhost:11434/api/generate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'codellama',
        prompt: `Given the following git diff, write a concise and descriptive commit message following the conventional commits specification. Focus on the main changes and their purpose. Keep it under 100 characters. Here's the diff:\n\n${diff}`,
        stream: false
      })
    });

    const data = await response.json();
    return data.response.trim();
  } catch (error) {
    console.log('âš ï¸  AI commit message generation failed, falling back to default format');
    return '';
  }
}

async function main() {
  try {
    // Stage all changes
    await $`git add .`;
    
    // Get the diff for AI analysis
    const { stdout: diffOutput } = await $`git diff --staged`;
    const diff = diffOutput.toString().trim();
    
    // Get list of staged files
    const { stdout: filesOutput } = await $`git diff --staged --name-only`;
    const files = filesOutput.toString().trim();
    
    if (!files) {
      console.log("No changes to commit");
      process.exit(0);
    }

    // Try to generate AI commit message
    const aiMessage = await generateCommitMessage(diff);
    
    // Use AI message if available, otherwise fall back to files list
    const commitMessage = aiMessage || `update: ${files.split('\n').join(', ')}`;
    
    // Commit changes
    await $`git commit -m ${commitMessage}`;
    
    // Push changes with animation
    console.log("ğŸš€ Initiating push sequence...");
    await $`git push`;
    
    // Show success animation
    await animate();
  } catch (error) {
    if (error instanceof Error) {
      console.error("âŒ Error:", error.message);
    } else {
      console.error("âŒ An unknown error occurred");
    }
    process.exit(1);
  }
}

main(); 